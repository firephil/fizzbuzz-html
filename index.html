<!DOCTYPE html>
<html>
    <head>
        <title>Programming in HTML</title>
    </head>
    <body>
        <div id='log'>
          <h3>This is generated by HTML code interpreted by JavaScript (look at the source code of this page)</h3>
        </div>

        <tt id="code">
           <for var="i" from="1" to="100">
               <switch>
                 <case condition="this.i % 15 === 0">
                   <print message="'FizzBuzz'">
                 </case>
                 <case condition="this.i % 3 === 0">
                   <print message="'Fizz'">
                 </case>
                 <case condition="this.i % 5 === 0">
                   <print message="'Buzz'">
                 </case>
                 <default>
                   <print message="this.i">
                 </default>
               </switch>
           </for>
        </tt>

        <script>
            let log = document.getElementById('log');
            let code = document.getElementById('code');

            function evalNode(node) {
                switch (node.tagName) {
                case 'FOR': {
                    const fromValue = parseInt(node.attributes['from'].value);
                    const toValue = parseInt(node.attributes['to'].value);
                    const varName = node.attributes['var'].value;
                    for (let i = fromValue; i <= toValue; ++i) {
                        let context = {};
                        context[varName] = i;
                        for (let forChild of node.children) {
                            evalNode.bind(context)(forChild);
                        }
                    }
                } break;
            
                case 'SWITCH': {
                    for (let switchChild of node.children) {
                        switch (switchChild.tagName) {
                        case 'CASE': {
                            const caseCondition = switchChild.attributes['condition'].value;
                            if (eval(caseCondition)) {
                                for (let caseChild of switchChild.children) {
                                    evalNode.bind(this)(caseChild);
                                }
                                return;
                            }
                        } break;
            
                        case 'DEFAULT': {
                            for (let defaultChild of switchChild.children) {
                                evalNode.bind(this)(defaultChild);
                            }
                            return;
                        } break;
            
                        default: {
                            throw `Unsupported tag ${switchChild.tagName} inside of a switch construct`;
                        }
                        }
                    }
                } break;
            
                case 'PRINT': {
                    log.innerHTML += (`<div>${eval(node.attributes['message'].value)}</div>`);
                } break;
            
                default:
                    throw `Unknown node '${node.tagName}'`;
                }
            }
            
            for (let child of code.children) {
                evalNode(child);
            }
        </script>
    </body>
</html>
